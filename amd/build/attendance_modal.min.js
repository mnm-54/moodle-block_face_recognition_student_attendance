define("block_face_recognition_student_attendance/attendance_modal",["exports","jquery","core/modal_factory","./webcam","core/ajax"],(function(_exports,_jquery,_modal_factory,_webcam,_ajax){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_jquery=_interopRequireDefault(_jquery),_modal_factory=_interopRequireDefault(_modal_factory),_webcam=_interopRequireDefault(_webcam),_ajax=_interopRequireDefault(_ajax);_exports.init=function(studentid,successmessage,failedmessage){(0,_jquery.default)(".action-modal").on("click",(function(){var st_img_url="",course_id=(0,_jquery.default)(this).attr("id"),request={methodname:"block_face_recognition_student_attendance_image_api",args:{courseid:course_id,studentid:studentid}};_ajax.default.call([request])[0].done((function(value){st_img_url=value.image_url})).fail(Notification.exception),_modal_factory.default.create({type:_modal_factory.default.types.SAVE_CANCEL,title:"Turn on webcam",body:'\n      <p>webcam will be turned on to take video and image input for your attendance</p>\n      <button id=\'start-webcam\' class="btn btn-primary">Start Webcam</button>\n      <button id=\'stop-webcam\' class="btn btn-secondary">Cancel</button>\n      <video id="webcam" autoplay playsinline width="300" height="225"></video>\n      <canvas id="canvas" class="d-none"></canvas>\n      <img id="st-image" style="display: none;"/>\n      <button id="submit-attendance" style="display:none;" class="btn btn-primary">Submit attendance</button>\n      <button id="try-again" style="display:none;" class="btn btn-primary">Try again</button>\n      <div id="message"></div>'}).then((function(modal){modal.setSaveButtonText("Start Webcam"),modal.show(),(0,_jquery.default)(".modal-footer").hide();var webcamElement=document.getElementById("webcam"),canvasElement=document.getElementById("canvas"),studentimg=document.getElementById("st-image");studentimg.src=st_img_url;var st_img="",webcam=new _webcam.default(webcamElement,"user",canvasElement);function hideSubmitAttendance(){document.getElementById("submit-attendance").style.display="none"}function removeMessages(){for(var message=document.getElementById("message");message.hasChildNodes();)message.removeChild(message.firstChild)}function displayFailedMessage(){hideSubmitAttendance(),document.getElementById("try-again").style.display="block",displayMessage(failedmessage,0)}function displayMessage(message,flag){var spn=document.createElement("span");spn.textContent=message+".",spn.setAttribute("class",flag?"text-success":"text-danger"),document.getElementById("message").appendChild(spn)}function submitAttendance(st_img,image){var request={methodname:"block_face_recognition_student_attendance_face_recog_api",args:{studentimg:st_img,webcampicture:image}};_ajax.default.call([request])[0].done((function(value){var result=value.confidence;console.log(value),result>=.7?(console.log("Success"),hideSubmitAttendance(),displayMessage(successmessage,1),function(){var request={methodname:"block_face_recognition_student_attendance_update_db",args:{courseid:course_id,studentid:studentid}};_ajax.default.call([request])[0].done((function(){window.location.href=(0,_jquery.default)(location).attr("href")})).fail(Notification.exception)}()):displayFailedMessage()})).fail((function(err){window.console.log(err)}))}(0,_jquery.default)("#start-webcam").on("click",(function(){webcam.start().then((function(result){document.getElementById("submit-attendance").style.display="block",(0,_jquery.default)("#submit-attendance").on("click",(function(){removeMessages(),st_img||(st_img=function(studentimg){var canvas=document.createElement("canvas"),ctx=canvas.getContext("2d");return canvas.width=studentimg.width,canvas.height=studentimg.height,ctx.drawImage(studentimg,0,0),canvas.toDataURL("image/png")}(studentimg));var image=webcam.snap();submitAttendance(st_img,image)})),(0,_jquery.default)("#try-again").on("click",(function(){removeMessages(),document.getElementById("try-again").style.display="none",document.getElementById("submit-attendance").click()}))})).catch((function(err){window.console.log(err)}))})),(0,_jquery.default)("#stop-webcam").on("click",(function(){webcam.stop(),window.location.href=(0,_jquery.default)(location).attr("href")}))}))}))}}));

//# sourceMappingURL=attendance_modal.min.js.map