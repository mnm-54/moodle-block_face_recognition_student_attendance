{"version":3,"file":"attendance_modal.min.js","sources":["../src/attendance_modal.js"],"sourcesContent":["import $ from \"jquery\";\nimport ModalFactory from \"core/modal_factory\";\nimport Webcam from \"./webcam\";\nimport Ajax from \"core/ajax\";\nexport const init = (studentid, successmessage, failedmessage) => {\n  $(\".action-modal\").on(\"click\", function () {\n    let st_img_url = \"\";\n    let course_id = $(this).attr(\"id\");\n\n    // ajax call\n    let wsfunction = \"block_face_recognition_student_attendance_image_api\";\n    let params = {\n      courseid: course_id,\n      studentid: studentid,\n    };\n    let request = {\n      methodname: wsfunction,\n      args: params,\n    };\n\n    Ajax.call([request])[0]\n      .done(function (value) {\n        st_img_url = value[\"image_url\"];\n        console.log(st_img_url);\n        create_modal();\n      })\n      .fail(Notification.exception);\n    // end of ajax call\n\n    function create_modal() {\n      ModalFactory.create({\n        type: ModalFactory.types.SAVE_CANCEL,\n        title: \"Turn on webcam\",\n        body: `\n        <p>webcam will be turned on to take video and image input for your attendance</p>\n        <button id='start-webcam' class=\"btn btn-primary\">Start Webcam</button>\n        <button id='stop-webcam' class=\"btn btn-secondary\">Cancel</button>\n        <video id=\"webcam\" autoplay playsinline width=\"300\" height=\"225\"></video>\n        <canvas id=\"canvas\" class=\"d-none\"></canvas>\n        <img id=\"st-image\" style=\"display: none;\"/>\n        <button id=\"submit-attendance\" style=\"display:none;\" class=\"btn btn-primary\">Submit attendance</button>\n        <button id=\"try-again\" style=\"display:none;\" class=\"btn btn-primary\">Try again</button>\n        <div id=\"message\"></div>`,\n      }).then(function (modal) {\n        modal.setSaveButtonText(\"Start Webcam\");\n  \n        modal.show();\n        $(\".modal-footer\").hide();\n  \n        const webcamElement = document.getElementById(\"webcam\");\n        const canvasElement = document.getElementById(\"canvas\");\n        let studentimg = document.getElementById(\"st-image\");\n        studentimg.src = st_img_url;\n        let st_img = \"\";\n  \n        let webcam = new Webcam(webcamElement, \"user\", canvasElement);\n        function getDataUrl(studentimg) {\n          const canvas = document.createElement(\"canvas\");\n          const ctx = canvas.getContext(\"2d\");\n          // Set width and height\n          canvas.width = studentimg.width;\n          canvas.height = studentimg.height;\n          // Draw the image\n          ctx.drawImage(studentimg, 0, 0);\n          return canvas.toDataURL(\"image/png\");\n        }\n        function displaySubmitAttendance() {\n          document.getElementById(\"submit-attendance\").style.display = \"block\";\n        }\n        function hideSubmitAttendance() {\n          document.getElementById(\"submit-attendance\").style.display = \"none\";\n        }\n        function displayTryAgain() {\n          document.getElementById(\"try-again\").style.display = \"block\";\n        }\n        function hideTryAgain() {\n          document.getElementById(\"try-again\").style.display = \"none\";\n        }\n        function removeMessages() {\n          const message = document.getElementById(\"message\");\n          while (message.hasChildNodes()) {\n            message.removeChild(message.firstChild);\n          }\n        }\n        function displaySuccessMessage() {\n          hideSubmitAttendance();\n          displayMessage(successmessage, 1);\n        }\n        function displayFailedMessage() {\n          hideSubmitAttendance();\n          displayTryAgain();\n          displayMessage(failedmessage, 0);\n        }\n        function displayMessage(message, flag) {\n          var spn = document.createElement(\"span\");\n          spn.textContent = message + \".\";\n          spn.setAttribute(\"class\", flag ? \"text-success\" : \"text-danger\");\n          document.getElementById(\"message\").appendChild(spn);\n        }\n        function logAttendance() {\n          let wsfunction = \"block_face_recognition_student_attendance_update_db\";\n          let params = {\n            courseid: course_id,\n            studentid: studentid,\n          };\n          let request = {\n            methodname: wsfunction,\n            args: params,\n          };\n  \n          Ajax.call([request])[0]\n            .done(function () {\n              window.location.href = $(location).attr(\"href\");\n            })\n            .fail(Notification.exception);\n        }\n        function submitAttendance(st_img, image) {\n          let wsfunction =\n            \"block_face_recognition_student_attendance_face_recog_api\";\n          let params = {\n            studentimg: st_img,\n            webcampicture: image,\n          };\n          console.log(st_img);\n          console.log(image);\n          let request = {\n            methodname: wsfunction,\n            args: params,\n          };\n  \n          Ajax.call([request])[0]\n            .done(function (value) {\n              let result = value[\"confidence\"];\n              console.log(value);\n  \n              if (result >= 0.6) {\n                console.log(\"Success\");\n                displaySuccessMessage();\n                logAttendance();\n                setTimeout(() => {\n                  window.location.href = $(location).attr(\"href\");\n                }, 1000);\n              } else {\n                displayFailedMessage();\n              }\n            })\n            .fail(function (err) {\n              window.console.log(err);\n            });\n          // end of ajax call\n        }\n        $(\"#start-webcam\").on(\"click\", function () {\n          webcam\n            .start()\n            .then((result) => {\n              displaySubmitAttendance();\n  \n              $(\"#submit-attendance\").on(\"click\", function () {\n                removeMessages();\n                if (!st_img) {\n                  st_img = getDataUrl(studentimg);\n                }\n                let image = webcam.snap();\n                submitAttendance(st_img, image);\n              });\n              $(\"#try-again\").on(\"click\", function () {\n                removeMessages();\n                hideTryAgain();\n                document.getElementById(\"submit-attendance\").click();\n              });\n            })\n            .catch((err) => {\n              window.console.log(err);\n            });\n        });\n        $(\"#stop-webcam\").on(\"click\", function () {\n          webcam.stop();\n          window.location.href = $(location).attr(\"href\");\n        });\n      });\n    }\n  });\n};\n"],"names":["studentid","successmessage","failedmessage","on","st_img_url","course_id","this","attr","request","methodname","args","courseid","call","done","value","console","log","create","type","ModalFactory","types","SAVE_CANCEL","title","body","then","modal","setSaveButtonText","show","hide","webcamElement","document","getElementById","canvasElement","studentimg","src","st_img","webcam","Webcam","getDataUrl","canvas","createElement","ctx","getContext","width","height","drawImage","toDataURL","displaySubmitAttendance","style","display","hideSubmitAttendance","displayTryAgain","hideTryAgain","removeMessages","message","hasChildNodes","removeChild","firstChild","displaySuccessMessage","displayMessage","displayFailedMessage","flag","spn","textContent","setAttribute","appendChild","logAttendance","window","location","href","fail","Notification","exception","submitAttendance","image","wsfunction","params","webcampicture","result","setTimeout","err","start","snap","click","catch","stop"],"mappings":"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"}