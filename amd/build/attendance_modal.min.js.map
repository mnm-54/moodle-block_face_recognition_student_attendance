{"version":3,"file":"attendance_modal.min.js","sources":["../src/attendance_modal.js"],"sourcesContent":["import $ from \"jquery\";\nimport ModalFactory from \"core/modal_factory\";\nimport Webcam from \"./webcam\";\nimport Ajax from \"core/ajax\";\nexport const init = (studentid, successmessage, failedmessage) => {\n  $(\".action-modal\").on(\"click\", function () {\n    \n    let st_img_url = \"\";\n    let course_id = $(this).attr(\"id\");\n\n    // ajax call\n    let wsfunction = \"block_face_recognition_student_attendance_image_api\";\n    let params = {\n      courseid: course_id,\n      studentid: studentid,\n    };\n    let request = {\n      methodname: wsfunction,\n      args: params,\n    };\n\n    Ajax.call([request])[0]\n      .done(function (value) {\n        st_img_url = value[\"image_url\"];\n      })\n      .fail(Notification.exception);\n    // end of ajax call\n\n    ModalFactory.create({\n      type: ModalFactory.types.SAVE_CANCEL,\n      title: \"Turn on webcam\",\n      body: `\n      <p>webcam will be turned on to take video and image input for your attendance</p>\n      <button id='start-webcam' class=\"btn btn-primary\">Start Webcam</button>\n      <button id='stop-webcam' class=\"btn btn-secondary\">Cancel</button>\n      <video id=\"webcam\" autoplay playsinline width=\"300\" height=\"225\"></video>\n      <canvas id=\"canvas\" class=\"d-none\"></canvas>\n      <img id=\"st-image\" style=\"display: none;\"/>\n      <button id=\"submit-attendance\" style=\"display:none;\" class=\"btn btn-primary\">Submit attendance</button>\n      <button id=\"try-again\" style=\"display:none;\" class=\"btn btn-primary\">Try again</button>\n      <div id=\"message\"></div>`,\n    }).then(function (modal) {\n      modal.setSaveButtonText(\"Start Webcam\");\n\n      modal.show();\n      $(\".modal-footer\").hide();\n\n      const webcamElement = document.getElementById(\"webcam\");\n      const canvasElement = document.getElementById(\"canvas\");\n      let studentimg = document.getElementById(\"st-image\");\n      studentimg.src = st_img_url;\n      let st_img = \"\";\n\n      let webcam = new Webcam(webcamElement, \"user\", canvasElement);\n      function getDataUrl(studentimg) {\n        const canvas = document.createElement('canvas');\n        const ctx = canvas.getContext('2d');\n        // Set width and height\n        canvas.width = studentimg.width;\n        canvas.height = studentimg.height;\n        // Draw the image\n        ctx.drawImage(studentimg, 0, 0);\n        return canvas.toDataURL('image/png');\n      }\n      function displaySubmitAttendance() {\n        document.getElementById('submit-attendance').style.display = \"block\";\n      }\n      function hideSubmitAttendance() {\n        document.getElementById('submit-attendance').style.display = \"none\";\n      }\n      function displayTryAgain() {\n        document.getElementById('try-again').style.display = \"block\";\n      }\n      function hideTryAgain() {\n        document.getElementById('try-again').style.display = \"none\";\n      }\n      function removeMessages() {\n        const message = document.getElementById(\"message\");\n        while (message.hasChildNodes()) {\n          message.removeChild(message.firstChild);\n        }\n      }\n      function displaySuccessMessage () {\n        hideSubmitAttendance();\n        displayMessage(successmessage, 1);\n      } \n      function displayFailedMessage () {\n        hideSubmitAttendance();\n        displayTryAgain();\n        displayMessage(failedmessage, 0);\n        \n      }\n      function displayMessage(message, flag) {\n        var spn = document.createElement(\"span\");\n        spn.textContent = message + \".\";\n        spn.setAttribute('class', flag ? 'text-success' : 'text-danger');\n        document.getElementById('message').appendChild(spn);\n      }\n      function logAttendance() {\n             \n        let wsfunction =\n          \"block_face_recognition_student_attendance_update_db\";\n        let params = {\n          courseid: course_id,\n          studentid: studentid,\n        };\n        let request = {\n          methodname: wsfunction,\n          args: params,\n        };\n\n        Ajax.call([request])[0]\n          .done(function () {\n\n            window.location.href = $(location).attr(\"href\");\n          })\n          .fail(Notification.exception);\n      }\n      function submitAttendance (st_img, image) {\n        let wsfunction =\n          \"block_face_recognition_student_attendance_face_recog_api\";\n        let params = {\n          studentimg: st_img,\n          webcampicture: image,\n        };\n        let request = {\n          methodname: wsfunction,\n          args: params,\n        };\n\n        Ajax.call([request])[0]\n          .done(function (value) {\n            let result = value[\"confidence\"];\n            console.log(value);\n\n            if (result >= 0.7) {\n              console.log('Success');\n              displaySuccessMessage();\n              logAttendance();\n            } else {\n              displayFailedMessage();\n            }\n          })\n          .fail(function (err) {\n            window.console.log(err);\n          });\n        // end of ajax call\n      }\n      $(\"#start-webcam\").on(\"click\", function () {\n        webcam\n          .start()\n          .then((result) => {\n            displaySubmitAttendance();\n            \n            $('#submit-attendance').on('click', function () {\n              removeMessages();\n              if (!st_img) {\n                st_img = getDataUrl(studentimg);\n              }\n              let image = webcam.snap();\n              submitAttendance(st_img, image);    \n            });\n            $('#try-again').on('click', function () {\n              removeMessages();\n              hideTryAgain();\n              document.getElementById('submit-attendance').click();\n            });\n          })\n          .catch((err) => {\n            window.console.log(err);\n          });\n\n        // setInterval(() => {\n          // getting image\n          // if (!st_img) {\n\n          //   const canvas = document.createElement('canvas');\n          //   const ctx = canvas.getContext('2d');\n          //   // Set width and height\n          //   canvas.width = studentimg.width;\n          //   canvas.height = studentimg.height;\n          //   // Draw the image\n          //   ctx.drawImage(studentimg, 0, 0);\n          //   st_img = canvas.toDataURL('image/png');\n\n          // }\n\n          // var image = webcam.snap();\n          // console.log(st_img);\n          // console.log(image);\n\n          // // ajax call\n          // let wsfunction =\n          //   \"block_face_recognition_student_attendance_face_recog_api\";\n          // let params = {\n          //   studentimg: st_img,\n          //   webcampicture: image,\n          // };\n          // let request = {\n          //   methodname: wsfunction,\n          //   args: params,\n          // };\n\n          // Ajax.call([request])[0]\n          //   .done(function (value) {\n          //     let result = value[\"confidence\"];\n          //     console.log(value);\n\n          //     if (result >= 0.7) {\n          //       console.log('Success');\n          //       // ajax call\n          //       // let wsfunction =\n          //       //   \"block_face_recognition_student_attendance_update_db\";\n          //       // let params = {\n          //       //   courseid: course_id,\n          //       //   studentid: studentid,\n          //       // };\n          //       // let request = {\n          //       //   methodname: wsfunction,\n          //       //   args: params,\n          //       // };\n\n          //       // Ajax.call([request])[0]\n          //       //   .done(function () {\n\n          //       //     //window.location.href = $(location).attr(\"href\");\n          //       //   })\n          //       //   .fail(Notification.exception);\n          //       // // end of ajax call\n          //     }\n          //   })\n          //   .fail(function (err) {\n          //     window.console.log(err);\n          //   });\n          // end of ajax call\n        // }, 2000);\n      });\n      $(\"#stop-webcam\").on(\"click\", function () {\n        webcam.stop();\n        window.location.href = $(location).attr(\"href\");\n      });\n    });\n  });\n\n  \n};\n"],"names":["studentid","successmessage","failedmessage","on","st_img_url","course_id","this","attr","request","methodname","args","courseid","call","done","value","fail","Notification","exception","create","type","ModalFactory","types","SAVE_CANCEL","title","body","then","modal","setSaveButtonText","show","hide","webcamElement","document","getElementById","canvasElement","studentimg","src","st_img","webcam","Webcam","hideSubmitAttendance","style","display","removeMessages","message","hasChildNodes","removeChild","firstChild","displayFailedMessage","displayMessage","flag","spn","createElement","textContent","setAttribute","appendChild","submitAttendance","image","webcampicture","result","console","log","window","location","href","logAttendance","err","start","canvas","ctx","getContext","width","height","drawImage","toDataURL","getDataUrl","snap","click","catch","stop"],"mappings":"qhBAIoB,SAACA,UAAWC,eAAgBC,mCAC5C,iBAAiBC,GAAG,SAAS,eAEzBC,WAAa,GACbC,WAAY,mBAAEC,MAAMC,KAAK,MAQzBC,QAAU,CACZC,WANe,sDAOfC,KANW,CACXC,SAAUN,UACVL,UAAWA,0BAORY,KAAK,CAACJ,UAAU,GAClBK,MAAK,SAAUC,OACdV,WAAaU,MAAK,aAEnBC,KAAKC,aAAaC,kCAGRC,OAAO,CAClBC,KAAMC,uBAAaC,MAAMC,YACzBC,MAAO,iBACPC,sqBAUCC,MAAK,SAAUC,OAChBA,MAAMC,kBAAkB,gBAExBD,MAAME,2BACJ,iBAAiBC,WAEbC,cAAgBC,SAASC,eAAe,UACxCC,cAAgBF,SAASC,eAAe,UAC1CE,WAAaH,SAASC,eAAe,YACzCE,WAAWC,IAAM/B,eACbgC,OAAS,GAETC,OAAS,IAAIC,gBAAOR,cAAe,OAAQG,wBActCM,uBACPR,SAASC,eAAe,qBAAqBQ,MAAMC,QAAU,gBAQtDC,yBACDC,QAAUZ,SAASC,eAAe,WACjCW,QAAQC,iBACbD,QAAQE,YAAYF,QAAQG,qBAOvBC,uBACPR,uBAhBAR,SAASC,eAAe,aAAaQ,MAAMC,QAAU,QAkBrDO,eAAe9C,cAAe,YAGvB8C,eAAeL,QAASM,UAC3BC,IAAMnB,SAASoB,cAAc,QACjCD,IAAIE,YAAcT,QAAU,IAC5BO,IAAIG,aAAa,QAASJ,KAAO,eAAiB,eAClDlB,SAASC,eAAe,WAAWsB,YAAYJ,cAsBxCK,iBAAkBnB,OAAQoB,WAO7BhD,QAAU,CACZC,WANA,2DAOAC,KANW,CACXwB,WAAYE,OACZqB,cAAeD,sBAOZ5C,KAAK,CAACJ,UAAU,GAClBK,MAAK,SAAUC,WACV4C,OAAS5C,MAAK,WAClB6C,QAAQC,IAAI9C,OAER4C,QAAU,IACZC,QAAQC,IAAI,WArDlBrB,uBACAS,eAAe/C,eAAgB,kBAsB3BO,QAAU,CACZC,WANA,sDAOAC,KANW,CACXC,SAAUN,UACVL,UAAWA,0BAORY,KAAK,CAACJ,UAAU,GAClBK,MAAK,WAEJgD,OAAOC,SAASC,MAAO,mBAAED,UAAUvD,KAAK,WAEzCQ,KAAKC,aAAaC,WAsBf+C,IAEAjB,0BAGHhC,MAAK,SAAUkD,KACdJ,OAAOF,QAAQC,IAAIK,4BAIvB,iBAAiB9D,GAAG,SAAS,WAC7BkC,OACG6B,QACAzC,MAAK,SAACiC,QAtFT3B,SAASC,eAAe,qBAAqBQ,MAAMC,QAAU,4BAyFvD,sBAAsBtC,GAAG,SAAS,WAClCuC,iBACKN,SACHA,gBAvGUF,gBACZiC,OAASpC,SAASoB,cAAc,UAChCiB,IAAMD,OAAOE,WAAW,aAE9BF,OAAOG,MAAQpC,WAAWoC,MAC1BH,OAAOI,OAASrC,WAAWqC,OAE3BH,IAAII,UAAUtC,WAAY,EAAG,GACtBiC,OAAOM,UAAU,aA+FPC,CAAWxC,iBAElBsB,MAAQnB,OAAOsC,OACnBpB,iBAAiBnB,OAAQoB,8BAEzB,cAAcrD,GAAG,SAAS,WAC1BuC,iBAzFNX,SAASC,eAAe,aAAaQ,MAAMC,QAAU,OA2F/CV,SAASC,eAAe,qBAAqB4C,cAGhDC,OAAM,SAACZ,KACNJ,OAAOF,QAAQC,IAAIK,+BAoEvB,gBAAgB9D,GAAG,SAAS,WAC5BkC,OAAOyC,OACPjB,OAAOC,SAASC,MAAO,mBAAED,UAAUvD,KAAK"}