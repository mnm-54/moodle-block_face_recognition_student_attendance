{"version":3,"file":"attendance_modal.min.js","sources":["../src/attendance_modal.js"],"sourcesContent":["import $ from \"jquery\";\nimport ModalFactory from \"core/modal_factory\";\nimport Notification from \"core/notification\";\nimport Webcam from \"./webcam\";\nimport Ajax from \"core/ajax\";\nexport const init = (studentid, successmessage, failedmessage) => {\n  $(\".action-modal\").on(\"click\", function () {\n    let st_img_url = \"\";\n    let course_name = \"\";\n    let course_id = $(this).attr(\"id\");\n\n    // ajax call\n    let wsfunction = \"block_face_recognition_student_attendance_image_api\";\n    let params = {\n      courseid: course_id,\n      studentid: studentid,\n    };\n    let request = {\n      methodname: wsfunction,\n      args: params,\n    };\n\n    Ajax.call([request])[0]\n      .done(function (value) {\n        st_img_url = value[\"image_url\"];\n        course_name = value[\"course_name\"];\n        create_modal();\n      })\n      .fail(Notification.exception);\n    // end of ajax call\n\n    let create_modal = () => {\n      ModalFactory.create({\n        type: ModalFactory.types.SAVE_CANCEL,\n        title: \"Turn on webcam\",\n        body: `\n        <div>\n        <p>Webcam will be turned on to take video and image input for your attendance.\n        <i class=\"icon fa fa-exclamation-circle text-muted fa-fw \" \n            title=\"If facing any issue with webcam, refresh the site and try again\" role=\"img\" \n            aria-label=\"If facing any issue with webcam, refresh the site and try again\">\n        </i>\n        </p>\n        </div>\n        <video id=\"webcam\" autoplay playsinline width=\"300\" height=\"225\" style=\"display:none;margin:auto\"></video>\n        <canvas id=\"canvas\" class=\"d-none\" style=\"display:none;\"></canvas>\n        <img id=\"st-image\" style=\"display: none;\"/>\n        <div style=\"display: flex; flex-wrap: wrap; align-items: center; justify-content: center; padding: 0.75rem;\">\n        \n          <button id='start-webcam' class=\"btn btn-primary\" >Start Webcam</button>\n          <button id=\"submit-attendance\" style=\"display:none;\" class=\"btn btn-primary\" >Submit attendance</button>\n          <button id=\"try-again\" style=\"display:none;\" class=\"btn btn-primary\" >Try again</button>\n          <button id='stop-webcam' class=\"btn btn-secondary\" style=\"margin-left:5px;\">Cancel</button>\n        \n        </div>\n        <div id=\"message\"></div>`,\n      }).then(function (modal) {\n        modal.show();\n        $(\".modal-footer\").hide();\n\n        const webcamElement = document.getElementById(\"webcam\");\n        const canvasElement = document.getElementById(\"canvas\");\n        let studentimg = document.getElementById(\"st-image\");\n        studentimg.src = st_img_url;\n        let st_img = \"\";\n\n        let webcam = new Webcam(webcamElement, \"user\", canvasElement);\n\n        $(\".close\").on(\"click\", function () {\n          webcam.stop();\n          window.location.href = $(location).attr(\"href\");\n        });\n\n        let getDataUrl = (studentimg) => {\n          const canvas = document.createElement(\"canvas\");\n          const ctx = canvas.getContext(\"2d\");\n          // Set width and height\n          canvas.width = studentimg.width;\n          canvas.height = studentimg.height;\n          // Draw the image\n          ctx.drawImage(studentimg, 0, 0);\n          return canvas.toDataURL(\"image/png\");\n        };\n        let displaySubmitAttendance = () => {\n          document.getElementById(\"submit-attendance\").style.display = \"block\";\n        };\n        let hideSubmitAttendance = () => {\n          document.getElementById(\"submit-attendance\").style.display = \"none\";\n        };\n        let displayTryAgain = () => {\n          document.getElementById(\"try-again\").style.display = \"block\";\n        };\n        let hideTryAgain = () => {\n          document.getElementById(\"try-again\").style.display = \"none\";\n        };\n        let removeMessages = () => {\n          const message = document.getElementById(\"message\");\n          while (message.hasChildNodes()) {\n            message.removeChild(message.firstChild);\n          }\n        };\n        let displaySuccessMessage = () => {\n          hideSubmitAttendance();\n          displayMessage(successmessage, 1);\n        };\n        let displayFailedMessage = () => {\n          hideSubmitAttendance();\n          displayTryAgain();\n          displayMessage(failedmessage, 0);\n        };\n        let displayMessage = (message, flag) => {\n          var spn = document.createElement(\"span\");\n          spn.textContent = message + \".\";\n          spn.setAttribute(\"class\", flag ? \"text-success\" : \"text-danger\");\n          document.getElementById(\"message\").appendChild(spn);\n        };\n        let logAttendance = () => {\n          let wsfunction =\n            \"block_face_recognition_student_attendance_update_db\";\n          let params = {\n            courseid: course_id,\n            studentid: studentid,\n          };\n          let request = {\n            methodname: wsfunction,\n            args: params,\n          };\n\n          Ajax.call([request])[0]\n            .done(function () {\n              window.console.log(\"Attendance logged\");\n            })\n            .fail(Notification.exception);\n        };\n        let submitAttendance = (st_img, image) => {\n          let wsfunction =\n            \"block_face_recognition_student_attendance_face_recog_api\";\n          let params = {\n            studentimg: st_img,\n            webcampicture: image,\n          };\n          let request = {\n            methodname: wsfunction,\n            args: params,\n          };\n\n          Ajax.call([request])[0]\n            .done(function (value) {\n              let result = value[\"confidence\"];\n              window.console.log(value);\n\n              if (result >= 0.6) {\n                let today = new Date();\n                webcam.stop();\n                displaySuccessMessage();\n                logAttendance();\n\n                Notification.confirm(\n                  \"Attendance submitted successfully\",\n                  `\n                  Course: ${course_name}<br>\n                  Date: ${today.toLocaleDateString(\"en-UK\")}<br>\n                  `,\n                  \"Continue\", // Confirm.\n                  \"Cancel\", // Cancel.\n                  () => (window.location.href = $(location).attr(\"href\")),\n                  () => (window.location.href = $(location).attr(\"href\"))\n                );\n              } else {\n                displayFailedMessage();\n              }\n            })\n            .fail(function (err) {\n              window.console.log(err);\n            });\n          // end of ajax call\n        };\n        // let getRequestForCheckingActiveWindowAPI = (course_id) => {\n        //   let wsfunction =\n        //     \"block_face_recognition_student_attendance_check_active_window\";\n        //   let params = {\n        //     courseid: course_id\n        //   };\n        //   let request = {\n        //     methodname: wsfunction,\n        //     args: params,\n        //   };\n        //   return request;\n        // }\n        $(\"#start-webcam\").on(\"click\", function () {\n          webcamElement.style.display = \"block\";\n          canvasElement.style.display = \"block\";\n          $(\"#start-webcam\").hide();\n          webcam\n            .start()\n            .then((result) => {\n              displaySubmitAttendance();\n\n              $(\"#submit-attendance\").on(\"click\", function () {\n                removeMessages();\n                if (!st_img) {\n                  st_img = getDataUrl(studentimg);\n                }\n                let image = webcam.snap();\n                //let request = getRequestForCheckingActiveWindowAPI(course_id);\n                let wsfunction =\n                  \"block_face_recognition_student_attendance_check_active_window\";\n                let params = {\n                  courseid: course_id\n                };\n                let request = {\n                  methodname: wsfunction,\n                  args: params,\n                };\n                console.log(params);\n                \n                Ajax.call([request])[0]\n                .done(function (value) {\n                  console.log(value);\n                  if(value.active == 1) {\n                    console.log('Active Course');\n                    submitAttendance(st_img, image);\n                  }\n                  else {\n                    displayMessage(\"Course is not open for taking attendance\", 0);\n                  }\n                })\n                .fail(function (err) {\n                  window.console.log(err);\n                });\n                \n\n              });\n              $(\"#try-again\").on(\"click\", function () {\n                removeMessages();\n                hideTryAgain();\n                document.getElementById(\"submit-attendance\").click();\n              });\n            })\n            .catch((err) => {\n              window.console.log(err);\n            });\n        });\n        $(\"#stop-webcam\").on(\"click\", function () {\n          webcam.stop();\n          window.location.href = $(location).attr(\"href\");\n        });\n      });\n    };\n  });\n};\n"],"names":["studentid","successmessage","failedmessage","on","st_img_url","course_name","course_id","this","attr","request","methodname","args","courseid","call","done","value","create_modal","fail","Notification","exception","create","type","ModalFactory","types","SAVE_CANCEL","title","body","then","modal","show","hide","webcamElement","document","getElementById","canvasElement","studentimg","src","st_img","webcam","Webcam","stop","window","location","href","hideSubmitAttendance","style","display","removeMessages","message","hasChildNodes","removeChild","firstChild","displayFailedMessage","displayMessage","flag","spn","createElement","textContent","setAttribute","appendChild","submitAttendance","image","webcampicture","result","console","log","today","Date","logAttendance","confirm","toLocaleDateString","err","start","canvas","ctx","getContext","width","height","drawImage","toDataURL","getDataUrl","snap","params","active","click","catch"],"mappings":"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"}