{"version":3,"sources":["../src/attendance_modal.js"],"names":["init","studentid","successmessage","failedmessage","on","st_img_url","course_id","attr","Ajax","call","methodname","args","courseid","done","value","fail","Notification","exception","ModalFactory","create","type","types","SAVE_CANCEL","title","body","then","modal","setSaveButtonText","show","hide","webcamElement","document","getElementById","canvasElement","studentimg","src","st_img","webcam","Webcam","getDataUrl","canvas","createElement","ctx","getContext","width","height","drawImage","toDataURL","displaySubmitAttendance","style","display","hideSubmitAttendance","displayTryAgain","hideTryAgain","removeMessages","message","hasChildNodes","removeChild","firstChild","displaySuccessMessage","displayMessage","displayFailedMessage","flag","spn","textContent","setAttribute","appendChild","logAttendance","window","location","href","submitAttendance","image","webcampicture","result","console","log","err","start","snap","click","catch","stop"],"mappings":"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","sourcesContent":["import $ from \"jquery\";\nimport ModalFactory from \"core/modal_factory\";\nimport Webcam from \"./webcam\";\nimport Ajax from \"core/ajax\";\nexport const init = (studentid, successmessage, failedmessage) => {\n  $(\".action-modal\").on(\"click\", function () {\n    let st_img_url = \"\";\n    let course_id = $(this).attr(\"id\");\n\n    // ajax call\n    let wsfunction = \"block_face_recognition_student_attendance_image_api\";\n    let params = {\n      courseid: course_id,\n      studentid: studentid,\n    };\n    let request = {\n      methodname: wsfunction,\n      args: params,\n    };\n\n    Ajax.call([request])[0]\n      .done(function (value) {\n        st_img_url = value[\"image_url\"];\n      })\n      .fail(Notification.exception);\n    // end of ajax call\n\n    ModalFactory.create({\n      type: ModalFactory.types.SAVE_CANCEL,\n      title: \"Turn on webcam\",\n      body: `\n      <p>webcam will be turned on to take video and image input for your attendance</p>\n      <button id='start-webcam' class=\"btn btn-primary\">Start Webcam</button>\n      <button id='stop-webcam' class=\"btn btn-secondary\">Cancel</button>\n      <video id=\"webcam\" autoplay playsinline width=\"300\" height=\"225\"></video>\n      <canvas id=\"canvas\" class=\"d-none\"></canvas>\n      <img id=\"st-image\" style=\"display: none;\"/>\n      <button id=\"submit-attendance\" style=\"display:none;\" class=\"btn btn-primary\">Submit attendance</button>\n      <button id=\"try-again\" style=\"display:none;\" class=\"btn btn-primary\">Try again</button>\n      <div id=\"message\"></div>`,\n    }).then(function (modal) {\n      modal.setSaveButtonText(\"Start Webcam\");\n\n      modal.show();\n      $(\".modal-footer\").hide();\n\n      const webcamElement = document.getElementById(\"webcam\");\n      const canvasElement = document.getElementById(\"canvas\");\n      let studentimg = document.getElementById(\"st-image\");\n      studentimg.src = st_img_url;\n      let st_img = \"\";\n\n      let webcam = new Webcam(webcamElement, \"user\", canvasElement);\n      function getDataUrl(studentimg) {\n        const canvas = document.createElement(\"canvas\");\n        const ctx = canvas.getContext(\"2d\");\n        // Set width and height\n        canvas.width = studentimg.width;\n        canvas.height = studentimg.height;\n        // Draw the image\n        ctx.drawImage(studentimg, 0, 0);\n        return canvas.toDataURL(\"image/png\");\n      }\n      function displaySubmitAttendance() {\n        document.getElementById(\"submit-attendance\").style.display = \"block\";\n      }\n      function hideSubmitAttendance() {\n        document.getElementById(\"submit-attendance\").style.display = \"none\";\n      }\n      function displayTryAgain() {\n        document.getElementById(\"try-again\").style.display = \"block\";\n      }\n      function hideTryAgain() {\n        document.getElementById(\"try-again\").style.display = \"none\";\n      }\n      function removeMessages() {\n        const message = document.getElementById(\"message\");\n        while (message.hasChildNodes()) {\n          message.removeChild(message.firstChild);\n        }\n      }\n      function displaySuccessMessage() {\n        hideSubmitAttendance();\n        displayMessage(successmessage, 1);\n      }\n      function displayFailedMessage() {\n        hideSubmitAttendance();\n        displayTryAgain();\n        displayMessage(failedmessage, 0);\n      }\n      function displayMessage(message, flag) {\n        var spn = document.createElement(\"span\");\n        spn.textContent = message + \".\";\n        spn.setAttribute(\"class\", flag ? \"text-success\" : \"text-danger\");\n        document.getElementById(\"message\").appendChild(spn);\n      }\n      function logAttendance() {\n        let wsfunction = \"block_face_recognition_student_attendance_update_db\";\n        let params = {\n          courseid: course_id,\n          studentid: studentid,\n        };\n        let request = {\n          methodname: wsfunction,\n          args: params,\n        };\n\n        Ajax.call([request])[0]\n          .done(function () {\n            window.location.href = $(location).attr(\"href\");\n          })\n          .fail(Notification.exception);\n      }\n      function submitAttendance(st_img, image) {\n        let wsfunction =\n          \"block_face_recognition_student_attendance_face_recog_api\";\n        let params = {\n          studentimg: st_img,\n          webcampicture: image,\n        };\n        let request = {\n          methodname: wsfunction,\n          args: params,\n        };\n\n        Ajax.call([request])[0]\n          .done(function (value) {\n            let result = value[\"confidence\"];\n            console.log(value);\n\n            if (result >= 0.7) {\n              console.log(\"Success\");\n              displaySuccessMessage();\n              logAttendance();\n            } else {\n              displayFailedMessage();\n            }\n          })\n          .fail(function (err) {\n            window.console.log(err);\n          });\n        // end of ajax call\n      }\n      $(\"#start-webcam\").on(\"click\", function () {\n        webcam\n          .start()\n          .then((result) => {\n            displaySubmitAttendance();\n\n            $(\"#submit-attendance\").on(\"click\", function () {\n              removeMessages();\n              if (!st_img) {\n                st_img = getDataUrl(studentimg);\n              }\n              let image = webcam.snap();\n              submitAttendance(st_img, image);\n            });\n            $(\"#try-again\").on(\"click\", function () {\n              removeMessages();\n              hideTryAgain();\n              document.getElementById(\"submit-attendance\").click();\n            });\n          })\n          .catch((err) => {\n            window.console.log(err);\n          });\n      });\n      $(\"#stop-webcam\").on(\"click\", function () {\n        webcam.stop();\n        window.location.href = $(location).attr(\"href\");\n      });\n    });\n  });\n};\n"],"file":"attendance_modal.min.js"}