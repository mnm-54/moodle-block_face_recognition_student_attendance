{"version":3,"sources":["../src/attendance_modal.js"],"names":["init","studentid","successmessage","failedmessage","on","st_img_url","course_id","attr","Ajax","call","methodname","args","courseid","done","value","create_modal","fail","Notification","exception","ModalFactory","create","type","types","SAVE_CANCEL","title","body","then","modal","show","hide","webcamElement","document","getElementById","canvasElement","studentimg","src","st_img","webcam","Webcam","stop","window","location","href","getDataUrl","canvas","createElement","ctx","getContext","width","height","drawImage","toDataURL","displaySubmitAttendance","style","display","hideSubmitAttendance","displayTryAgain","hideTryAgain","removeMessages","message","hasChildNodes","removeChild","firstChild","displaySuccessMessage","displayMessage","displayFailedMessage","flag","spn","textContent","setAttribute","appendChild","logAttendance","submitAttendance","image","webcampicture","result","console","log","setTimeout","alert","err","start","snap","click","catch"],"mappings":"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","sourcesContent":["import $ from \"jquery\";\nimport ModalFactory from \"core/modal_factory\";\nimport Notification from \"core/notification\";\nimport Webcam from \"./webcam\";\nimport Ajax from \"core/ajax\";\nexport const init = (studentid, successmessage, failedmessage) => {\n  $(\".action-modal\").on(\"click\", function () {\n    let st_img_url = \"\";\n    let course_id = $(this).attr(\"id\");\n\n    // ajax call\n    let wsfunction = \"block_face_recognition_student_attendance_image_api\";\n    let params = {\n      courseid: course_id,\n      studentid: studentid,\n    };\n    let request = {\n      methodname: wsfunction,\n      args: params,\n    };\n\n    Ajax.call([request])[0]\n      .done(function (value) {\n        st_img_url = value[\"image_url\"];\n        create_modal();\n      })\n      .fail(Notification.exception);\n    // end of ajax call\n\n    let create_modal = () => {\n      ModalFactory.create({\n        type: ModalFactory.types.SAVE_CANCEL,\n        title: \"Turn on webcam\",\n        body: `\n        <div>\n        <p>Webcam will be turned on to take video and image input for your attendance.\n        <i class=\"icon fa fa-exclamation-circle text-muted fa-fw \" \n            title=\"If facing any issue with webcam, refresh the site and try again\" role=\"img\" \n            aria-label=\"If facing any issue with webcam, refresh the site and try again\">\n        </i>\n        </p>\n        </div>\n        <video id=\"webcam\" autoplay playsinline width=\"300\" height=\"225\" style=\"display:none;margin:10px 60px\"></video>\n        <canvas id=\"canvas\" class=\"d-none\" style=\"display:none;\"></canvas>\n        <img id=\"st-image\" style=\"display: none;\"/>\n        <div style=\"display: flex; flex-wrap: wrap; align-items: center; justify-content: flex-end; padding: 0.75rem;\">\n        <button id='start-webcam' class=\"btn btn-primary\" >Start Webcam</button>\n        <button id=\"submit-attendance\" style=\"display:none;\" class=\"btn btn-primary\" >Submit attendance</button>\n        <button id=\"try-again\" style=\"display:none;\" class=\"btn btn-primary\" >Try again</button>\n        <button id='stop-webcam' class=\"btn btn-secondary\" style=\"margin-left:5px;\">Cancel</button>\n        </div>\n        <div id=\"message\"></div>`,\n      }).then(function (modal) {\n        modal.show();\n        $(\".modal-footer\").hide();\n\n        const webcamElement = document.getElementById(\"webcam\");\n        const canvasElement = document.getElementById(\"canvas\");\n        let studentimg = document.getElementById(\"st-image\");\n        studentimg.src = st_img_url;\n        let st_img = \"\";\n\n        let webcam = new Webcam(webcamElement, \"user\", canvasElement);\n\n        $(\".close\").on(\"click\", function () {\n          webcam.stop();\n          window.location.href = $(location).attr(\"href\");\n        });\n\n        let getDataUrl = (studentimg) => {\n          const canvas = document.createElement(\"canvas\");\n          const ctx = canvas.getContext(\"2d\");\n          // Set width and height\n          canvas.width = studentimg.width;\n          canvas.height = studentimg.height;\n          // Draw the image\n          ctx.drawImage(studentimg, 0, 0);\n          return canvas.toDataURL(\"image/png\");\n        };\n        let displaySubmitAttendance = () => {\n          document.getElementById(\"submit-attendance\").style.display = \"block\";\n        };\n        let hideSubmitAttendance = () => {\n          document.getElementById(\"submit-attendance\").style.display = \"none\";\n        };\n        let displayTryAgain = () => {\n          document.getElementById(\"try-again\").style.display = \"block\";\n        };\n        let hideTryAgain = () => {\n          document.getElementById(\"try-again\").style.display = \"none\";\n        };\n        let removeMessages = () => {\n          const message = document.getElementById(\"message\");\n          while (message.hasChildNodes()) {\n            message.removeChild(message.firstChild);\n          }\n        };\n        let displaySuccessMessage = () => {\n          hideSubmitAttendance();\n          displayMessage(successmessage, 1);\n        };\n        let displayFailedMessage = () => {\n          hideSubmitAttendance();\n          displayTryAgain();\n          displayMessage(failedmessage, 0);\n        };\n        let displayMessage = (message, flag) => {\n          var spn = document.createElement(\"span\");\n          spn.textContent = message + \".\";\n          spn.setAttribute(\"class\", flag ? \"text-success\" : \"text-danger\");\n          document.getElementById(\"message\").appendChild(spn);\n        };\n        let logAttendance = () => {\n          let wsfunction =\n            \"block_face_recognition_student_attendance_update_db\";\n          let params = {\n            courseid: course_id,\n            studentid: studentid,\n          };\n          let request = {\n            methodname: wsfunction,\n            args: params,\n          };\n\n          Ajax.call([request])[0]\n            .done(function () {\n              // window.location.href = $(location).attr(\"href\");\n            })\n            .fail(Notification.exception);\n        };\n        let submitAttendance = (st_img, image) => {\n          let wsfunction =\n            \"block_face_recognition_student_attendance_face_recog_api\";\n          let params = {\n            studentimg: st_img,\n            webcampicture: image,\n          };\n          let request = {\n            methodname: wsfunction,\n            args: params,\n          };\n\n          Ajax.call([request])[0]\n            .done(function (value) {\n              let result = value[\"confidence\"];\n              window.console.log(value);\n\n              if (result >= 0.6) {\n                window.console.log(\"Success\");\n                displaySuccessMessage();\n                logAttendance();\n\n                setTimeout(() => {\n                  window.location.href = $(location).attr(\"href\");\n                }, 2000);\n\n                Notification.alert(\n                  \"Attendance Status\",\n                  \"Attendance Submitted Successfully\",\n                  \"Continue\"\n                );\n              } else {\n                displayFailedMessage();\n              }\n            })\n            .fail(function (err) {\n              window.console.log(err);\n            });\n          // end of ajax call\n        };\n        $(\"#start-webcam\").on(\"click\", function () {\n          webcamElement.style.display = \"block\";\n          canvasElement.style.display = \"block\";\n          $(\"#start-webcam\").hide();\n          webcam\n            .start()\n            .then((result) => {\n              displaySubmitAttendance();\n\n              $(\"#submit-attendance\").on(\"click\", function () {\n                removeMessages();\n                if (!st_img) {\n                  st_img = getDataUrl(studentimg);\n                }\n                let image = webcam.snap();\n                submitAttendance(st_img, image);\n              });\n              $(\"#try-again\").on(\"click\", function () {\n                removeMessages();\n                hideTryAgain();\n                document.getElementById(\"submit-attendance\").click();\n              });\n            })\n            .catch((err) => {\n              window.console.log(err);\n            });\n        });\n        $(\"#stop-webcam\").on(\"click\", function () {\n          webcam.stop();\n          window.location.href = $(location).attr(\"href\");\n        });\n      });\n    };\n  });\n};\n"],"file":"attendance_modal.min.js"}